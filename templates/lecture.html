{% extends 'header.html' %}
{% block title %}{{ cls['display_name'] }} - {{ lecture['name'] }}{% endblock %}
{% block head %}{{ super() }}{% endblock %}
{% block content %}
<style>
ul#menu li {
    display:inline;
}
</style>
<div class="wrapper text-primary">
  <div class="row">
    <div class="col-md-7">
      <div id="ytplayer"></div>
      {% if playlist_number %}
      <div class="navbar">
      {% if playlist_number|int != 0|int %}
      <a href={{ url_for('lecture', cls= cls_num, lecture_number= lecture_num, playlist_number= ((playlist_number|int - 1|int)|string)) }}>
        <button class="btn btn-primary submission" >Previous Video</button>
      </a>
      {% endif %}
      {% for lec in range(video_info['num_videos']) %}
      {% if playlist_number|int == lec|int %}
        <b><u><font size ="2" color="black"> {{lec}}. {{lecture['vid_title'][lec]}}</font></u></b>
      {% else %}
        <font size ="2"><a href={{ url_for('lecture', cls= cls_num, lecture_number= lecture_num, playlist_number= lec) }}>{{lec}}.{{lecture['vid_title'][lec]}}</a></font>
      {% endif %}
      {% endfor %}
      {% if playlist_number|int < (video_info['num_videos'] - 1)|int %}
        <a href={{ url_for('lecture', cls= cls_num, lecture_number= lecture_num, playlist_number= ((playlist_number|int + 1|int)|string)) }}>
          <button class="btn btn-sm btn-primary submission" >Next Video</button>
        </a>
      {% endif %}
      </div>
      {% endif %}
      <button id="display-full-transcript" class="btn btn-sm btn-primary">Display full transcript</button>
      <div id="transcript">
            {% for (link, (start, end)) in preds %}
              <table class='transcript-box'>
              {% for i in range(start, end + 1) %}
                  <tr id="transcript-row-{{i}}" class="transcript-row">
                    <td>
                      <div class="dropdown" id="menu-{{i}}">
                      <span id="ts-{{2 * i}}"></span>
                        <a data-toggle="dropdown">
                          <span id="transcript-text-{{2 * i}}"></span>
                          <span id="transcript-text-{{2 * i + 1}}"></span>
                        </a>
                        <ul id="transcript-dropdown-{{i}}" class="dropdown-menu">
                          {% if link %}
                          <li><a onclick="sendToURL('{{link}}')"> View section in textbook</a></li>
                          {% endif %}
                          <li><a onclick="fillQuestion({{i}})"> Ask a question</a></li>
                        </ul>
                      </div>
                    </td>
                  </tr>
              {% endfor %}
              </table>
            {% endfor %}
      </div>
    </div>
    <div class="col-md-4">
      <div id="questions">
          <div class="form-group">
            <input id='question' class="form-control" placeholder='Enter your question here'></input>
          </div>
          <div class="row">
            <div class="form-group col-md-6">
                <input id="anonq" type="checkbox">  Post anonymously</input>
            </div>
            <div class="form-group col-md-6">
              <button class="btn btn-primary submission" type=submit onclick="sendQuestion()">Submit Question</button>
            </div>
          </div>
        <div class="row">
            <p>
              <button type="button" class="btn btn-default btn-sm" type=submit onclick='refreshQuestions()'>
                <i class="fa fa-refresh" aria-hidden="true"></i> Refresh
              </button>
          </p>
      </div>
      <section id="questions_table">
          {% for question_set, interval in app_utils.partition(db['Questions'].find({'$and':[{'lecture_id': lecture['_id']|string}, {'playlist_number': playlist_number|string }]}), questions_interval, video_info['duration']) %}
            {% if loop.index == 1 %}
                <a data-toggle="collapse" onclick="toggleResponses('partition-icon-{{loop.index}}')" data-target="#partition-{{loop.index}}"><span style="font-size: 18px" id="partition-icon-{{loop.index}}" class="fa fa-chevron-down qa-entry" aria-hidden="true"></span><strong>Top Questions</strong></a>
            {% else %}
                <a data-toggle="collapse" onclick="toggleResponses('partition-icon-{{loop.index}}')" data-target="#partition-{{loop.index}}"><span style="font-size: 18px" id="partition-icon-{{loop.index}}" class="fa fa-chevron-down qa-entry" aria-hidden="true"></span> {{interval[0]}} - {{interval[1]}}</a>
            {% endif %}

            <span style="display: block">
            <div id="partition-{{loop.index}}" class="collapse">


            {% for question in question_set %}

              <a id="show-answers-{{question['_id']}}" data-toggle="collapse" onclick="toggleResponses('toggle-icon-{{question['_id']}}')" data-target="#answers-{{question['_id']}}">
                <p><span class="fa fa-chevron-down qa-entry" id="toggle-icon-{{question['_id']}}" aria-hidden="true"></span></a>
                    <span id="upvotes-{{question['_id']}}"><button class="btn btn-default btn-sm likes"  type=submit onclick='upvoteQuestion("{{user['_id']}}", "{{question['_id']}}")'>
                      {% if user['_id']|string in question['upvotes'] %}
                      <i class="fa fa-thumbs-up" aria-hidden="true"></i> Like  <span id = "upvotes-{{question['_id']}}-count" class ="clicked">{{ question['upvotes']|length }}</span>
                      {% else %}
                      <i class="fa fa-thumbs-o-up" aria-hidden="true"></i> Like <span id = "upvotes-{{question['_id']}}-count" class = "notclicked"> {{ question['upvotes']|length }}</span>
                      {% endif %}
                  </button></span>
                {% if question['anon'] == "true" and role == consts.STUDENT %}
                  <span class="question-tag-lg"> Anonymous {{question['timestamp']}}</span>
                {% else %}
                  <span class="question-tag-lg"> {{question['name']}} {{question['timestamp']}}</span>
                {% endif %}
                <span class="qa-entry-lg"> {{question['text']}}</span>
                {% if role == consts.INSTRUCTOR %}
                  <a onclick='deleteQuestion("{{question['_id']}}")'><span class="fa fa-close" style="color:red"></span></a>
                {% endif %}
                </p>
            <div id="answers-container-{{question['_id']}}">
            <div id="answers-{{question['_id']}}" class="collapse">
                {% for answer in db['Answers'].find({'question_id': question['_id']}) %}
                    <div id="each-answer-{{answer['_id']}}">
                      <p><span id="upvotes-{{answer['_id']}}" class="qa-entry">
                      <button class="btn btn-default btn-sm likes" type=submit onclick='upvoteAnswer("{{user['_id']}}", "{{answer['_id']}}")'>
                          {% if user['_id']|string in answer['upvotes'] %}
                          <span id = "upvotes-{{answer['_id']}}-count" class = "notclicked">
                          <i class="fa fa-thumbs-up" aria-hidden="true"></i> Like <span id = "upvotes-{{answer['_id']}}-count" class = "notclicked"> {{ answer['upvotes']|length }}</span>
                          {% else %}
                          <i class="fa fa-thumbs-o-up" aria-hidden="true"></i> Like  <span id = "upvotes-{{answer['_id']}}-count" class = "clicked"> {{ answer['upvotes']|length }} </span>
                          {% endif %}
                      </button>
                    </span>
                    {% if answer['anon'] == "true" and user['role'] == consts.STUDENT %}
                        <span class="question-tag"> Anonymous</span>
                          <span class="qa-entry"> {{answer['text']}}</span>
                    {% else %}
                        <span class="question-tag"> {{answer['name']}}</span>
                          <span class="qa-entry">
                            <span id = "answer-text-{{answer['_id']}}">{{answer['text']}}
                            </span>
                          </span>
                    {% endif %}
                    {% if answer['user'] == user['_id'] or user['role'] == consts.INSTRUCTOR%}
                        <i class="fa fa-pencil" aria-hidden="true" type="submit" onclick='convertAnswerToInput("{{answer['_id']}}", "{{question['_id']}}")'></i>
                     {% endif %}
                    {% if user['role'] == consts.INSTRUCTOR %}
                      <i class="fa fa-close" style="color:red" onclick='deleteAnswer("{{answer['_id']}}", "{{question['_id']}}")'></i>
                    {% endif %}
                    </p>
                  </div>
                {% endfor %}
                    <div class="form-group">
                    <input id="answer-{{question['_id']}}" class="form-control qa-entry" placeholder='Enter your answer here'></input>
                    </div>
                    <div class="row">
                      <div class="form-group col-md-6">
                        <input id='anona-{{question['_id']}}' type="checkbox"></input><span class="qa-entry">  Answer anonymously</span>
                      </div>
                      <div class="col-md-3"></div>
                       <div class="form-group col-md-3">
                      <button class="btn btn-primary btn-sm qa-entry submission" type="submit" onclick='sendAnswer("{{question['_id']}}")'>Submit Answer</button>
                    </div>
                  </div>
            </div>
            </div>

            {% endfor %}
          </div>
        </span>

          {% endfor %}
        </section>
      </div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/lectureUtils.js') }}"></script>

<script>



  var tag = document.createElement('script');
  tag.src = "https://www.youtube.com/player_api";
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  var player;
  function onYouTubePlayerAPIReady() {
    player = new YT.Player('ytplayer', {
      height: window.innerHeight / 2,
      width: window.innerWidth / 2,
      videoId: '{{ video_info["video_id"] }}',
      playerVars: {rel: 0},
      events: {
        'onStateChange': stateChange,
        'onReady': onPlayerReady
      }
    });

  }


  function onPlayerReady() {

      toggleTopQuestions();

      transcriptElements = [];
      partitionTitles = [];

      // Push transcript, partitionTitles into JavaScript memory

      {% for transcript_element in transcript %}
      transcriptElements.push({
          begin: "{{transcript_element['begin']}}",
          end: "{{transcript_element['end']}}",
          text: "{{transcript_element['text']}}",
          suggestions: {{transcript_element['suggestions']|tojson}},
          interval: [convertToSeconds("{{transcript_element['begin']}}"), convertToSeconds("{{transcript_element['end']}}")]
      });
      {% endfor %}

      {% for begin, end in video_info['partition_titles'] %}
          partitionTitles.push({
              begin: "{{begin}}",
              end: "{{end}}",
              interval: [convertToSecondsTiny("{{begin}}"), convertToSecondsTiny("{{end}}")]
          })
      {% endfor %}

      var maxTranscriptIndex = 0;
      var maxTranscriptTime = 0;

      var renderTranscriptElement = function (transcriptElementIndex) {
          transcriptElement = transcriptElements[transcriptElementIndex];
          var p1 = document.getElementById(`ts-${transcriptElementIndex}`);
          if (p1) {
              p1.innerHTML = cleanTimestamp(transcriptElement.begin)
          }
          var p2 = document.getElementById(`transcript-text-${transcriptElementIndex}`);
          p2.innerHTML = transcriptElement.text;
          document.getElementById(`menu-${Math.floor(transcriptElementIndex / 2)}`).style.visibility = "visible";
      };

      var scrollToTranscriptElement = function (transcriptElementIndex) {
          $('#transcript').animate({
              scrollTop: $(`#transcript-row-${Math.floor(transcriptElementIndex / 2)}`).position().top
          }, 500);
      };

      var displayQA = function (begin, end) {
          var collapseButton = $(`a:contains('${begin} - ${end}')`);
          var div = $(collapseButton.attr('data-target'));
          if (div && div.attr('class') && div.attr('class').split(' ').indexOf('show') == -1) {
            toggleResponses(collapseButton.children()[0].id);
            div.collapse('show');
          }
      };

      var displayFullTranscript = function () {
          for (var i = maxTranscriptIndex; i < transcriptElements.length; i++) {
              if ($(`#transcript-text-${i}`).contents().length == 0) {
                  renderTranscriptElement(i);
              }
          }

          maxTranscriptIndex = transcriptElement.length;
          if (maxTranscriptIndex > 0) {
              maxTranscriptTime = transcriptElements[maxTranscriptIndex - 1].end;
          }
      };

      var sortChoices = function (choices) {
          return choices.sort(
              function (element1, element2) {
                  return element2['votes'] - element1['votes']
              }).map(
                  function (element) {
                      return element['text']
                  }
              );
      }

      $("span[id*='transcript-text']").on('contextmenu', function(event) {
          var index = parseInt($(this).attr('id').split('-').pop());
          console.log(index);
          var oldText = $(this).text();
          document.getElementById(`transcript-dropdown-${Math.floor(index / 2)}`).style.visibility = "hidden";
          if ($('[id*="suggestion"]').length == 0) {
              event.preventDefault();
              var suggestionInput = document.createElement('input');
              suggestionInput.id = `suggestion-${index}`;
              suggestionInput.size = oldText.length;
              suggestionInput.value = oldText;

              var choices = sortChoices(transcriptElements[index].suggestions);
              $(this).html(suggestionInput);

              $(`#suggestion-${index}`).typeahead(
                {
                    hint: true,
                    highlight: true,
                    minLength: 0
                },
                {
                    name: 'suggestions',
                    source: substringMatcher(choices)
                }
              );

              $(`#suggestion-${index}`).keydown(function(event) {
                if (event.keyCode == 13 || event.keyCode == 27) { // enter key
                  var parent = $(this).closest('span');
                  var text = $(this).val();
                  parent.html(oldText);
                  if (event.keyCode == 13) {
                    $.ajax({
                      type: "POST",
                      url: "{{ url_for('edit_transcript') }}",
                      data: {
                          text,
                          index,
                          user_id: '{{ user["_id"] }}',
                          lecture_id: '{{ lecture["_id"]|string }}',
                          playlist_number: '{{ playlist_number }}',
                          api_key: '{{ api_key }}'
                      }
                    });
                  }
                }
              });
          }
      });

      $("#display-full-transcript").click(displayFullTranscript);

      setInterval(function() {
          var currentTime = player.getCurrentTime();
          var state = player.getPlayerState();

          if (currentTime > maxTranscriptTime) {
              for (var i = maxTranscriptIndex; i < transcriptElements.length; i++) {
                  var transcriptElement = transcriptElements[i];
                  if ($(`#transcript-text-${i}`).contents().length == 0) {
                      renderTranscriptElement(i);
                  }

                  var endTime = transcriptElement.interval[1];
                  if (endTime > currentTime) {
                      maxTranscriptIndex = i;
                      maxTranscriptTime = endTime;
                      break;
                  }
              }
          }

          for (var i = 0; i < transcriptElements.length; i++) {
              var transcriptElement = transcriptElements[i];
              var endTime = transcriptElement.interval[1];
              if ((endTime > currentTime) && (state == 1)) {
                  scrollToTranscriptElement(i);
                  break;
              }
          }

          if (state == 1) {
              for (var i = 0; i < partitionTitles.length; i++) {
                  var partitionTitle = partitionTitles[i];
                  if (currentTime >= partitionTitle.interval[0] && currentTime < partitionTitle.interval[1]) {
                      displayQA(partitionTitle.begin, partitionTitle.end);
                  }
              }
          }

      }, {{questions_interval}} * 250);

  }

  function stateChange() {
      // recordData maybe
  }

  function convertAnswerToInput(answer, question){
    var currentVal = document.getElementById(`each-answer-${answer}`);
    var txt = document.getElementById(`answer-text-${answer}`).innerHTML;
    txt = txt.replace(/ /g, '&nbsp;');
    currentVal.innerHTML = `<input id= edit-answer-${answer} class="form-control qa-entry" value= ${txt}></input> <button class="btn btn-primary btn-sm qa-entry submission" type="submit" onclick='editAnswer("${answer}", "${question}")'>Submit Edit</button>`
  }
  function toggleTopQuestions() {
      toggleResponses('partition-icon-1');
      $('#partition-1').collapse("show");
  }

  function toggleResponses(buttonId) {
    elem = document.getElementById(buttonId);
    if (elem) {
      if (elem.classList.contains('fa-chevron-down')) {
        elem.classList.remove('fa-chevron-down');
        elem.classList.add('fa-chevron-up');
      } else {
        elem.classList.remove('fa-chevron-up');
        elem.classList.add('fa-chevron-down');
      }
    }
  }

  function sendQuestion() {
      var seconds = player.getCurrentTime();
      var question = document.getElementById('question').value;
      if (question.length > 0) {
        var anonymous = $('#anonq').is(":checked");
        var data = {
           seconds,
           text: question,
           name: "{{ user['name'] }}",
           ok_id: "{{ user['ok_id'] }}",
           lecture: "{{ lecture['_id']|string }}",
           cls: "{{ cls['_id']|string }}",
           anon: anonymous,
           playlist_num: "{{ playlist_number }}",
           api_key: "{{ api_key }}"
        }

        console.log(`${JSON.stringify(data)}`)

        $.ajax({
          type: "POST",
          url: "{{ url_for('write_question') }}",
          data,
          success: function (data) {
            $('#questions_table').load(window.location.href + ' #questions_table', function () {
                toggleTopQuestions()
            });

          }
        });
      }
    }

  function deleteQuestion(question) {
    var data = {
      question_id: question,
      api_key: "{{ api_key }}"
    }

    $.ajax({
      type: "POST",
      url: "{{ url_for('delete_question') }}",
      data: data,
      success: function (data) {
        $('#questions_table').load(window.location.href + ' #questions_table', function () {
            toggleTopQuestions()
        });
      }
    })
  }

  //NOTE: not sure about the success function

  function editAnswer(answerId, questionId) {
      var text = document.getElementById(`edit-answer-${answerId}`).value;
      var data = {
       text,
       api_key: "{{ api_key }}",
       answerId
      };

      $.ajax({
          type: "POST",
          url: "{{ url_for('edit_answer') }}",
          data,
          success: function (data) {
            $(`#answers-container-${questionId}`).load(window.location.href + ` #answers-container-${questionId}`, function () {
               $(`#show-answers-${questionId}`).trigger("click", function () {
                   toggleTopQuestions()
               });
           });
         }
       });
  }

  function deleteAnswer(answer, question) {
    var data = {
      answer_id: answer,
      api_key: "{{ api_key }}"
    };

    question_id = question;
    console.log(question);

    $.ajax({
      type: "POST",
      url: "{{ url_for('delete_answer') }}",
      data,
      success: function (data) {
        $(`#answers-container-${question}`).load(window.location.href + ` #answers-container-${question}`, function () {
            $(`#show-answers-${question}`).trigger("click", function () {
                toggleTopQuestions()
            });
        });
      }
    })
  }

  function upvoteAnswer(user, answer){
    var span = document.getElementById(`upvotes-${answer}-count`);
    var currentcount = parseInt(span.innerHTML);
    if(span.innerHTML.className == "notclicked"){
      span.innerHTML =  currentcount + 1;
    }
    else{
      span.innerHTML = currentcount - 1;
    }
    var data ={
      user_id:user,
      answer_id:answer,
      api_key: "{{ api_key }}"
    };
    console.log(`${JSON.stringify(data)}`)
    $.ajax({
      type: "POST",
      url: "{{ url_for('upvote_answer') }}",
      data,
      success: function (data) {

        $(`#upvotes-${answer}`).load(window.location.href + ` #upvotes-${answer}`, function () {
            toggleTopQuestions()
        });
      }
    });
  }

  function upvoteQuestion(user, question){
    var span = document.getElementById(`upvotes-${question}-count`)
    var currentcount = parseInt(span.innerHTML);
    if(span.innerHTML.className == "notclicked"){
      span.innerHTML =  currentcount + 1;
    }
    else{
      span.innerHTML = currentcount - 1;
    }

    var data ={
      user_id:user,
      question_id:question,
      api_key: "{{ api_key }}"
    };
    console.log(`${JSON.stringify(data)}`)
    $.ajax({
      type: "POST",
      url: "{{ url_for('upvote_question') }}",
      data,
      success: function (data) {
        $(`#upvotes-${question}`).load(window.location.href + `#upvotes-${question}`, function () {
            toggleTopQuestions()
        });
      }
    });
  }
  function sendAnswer(questionId) {

      var answer = document.getElementById(`answer-${questionId}`).value;
      var anonymous = $(`#anona-${questionId}`).is(":checked");;

      if (answer.length > 0) {
          if(anonymous == "1"){
            anonymous = (true);
          }
          else{
            anonymous = (false);
          }
          var data = {
             question_id: questionId,
             text: answer,
             anon: anonymous,
             api_key: "{{ api_key }}"
          };


          console.log(`${JSON.stringify(data)}`)

          $.ajax({
            type: "POST",
            url: "{{ url_for('write_answer') }}",
            data,
            success: function (data) {
              $(`#answers-container-${questionId}`).load(window.location.href + ` #answers-container-${questionId}`, function () {
                  $(`#show-answers-${questionId}`).trigger("click", function () {
                      toggleTopQuestions()
                  });
              });


            }
          });
      }
  }
  function sendToURL(url) {
      window.open(
        url,
        '_blank'
      );
  }

  function refreshQuestions(){
    $('#questions_table').load(window.location.href + ' #questions_table', function () {
        toggleTopQuestions()
    });
  }

  function fillQuestion(rowIndex) {
      var ts = $(`#ts-${2 * rowIndex}`);
      var rowElement1 = $(`#transcript-text-${2 * rowIndex}`);
      var rowElement2 = $(`#transcript-text-${2 * rowIndex + 1}`);
      console.log(ts.length + rowElement1.length + rowElement2.length);
      if (ts.length + rowElement1.length + rowElement2.length > 0) {
          $('#question').val(`${ts.text()} ${rowElement1.text()}  ${rowElement2.text()}`);
      }

  }

  function addResource(){
    var seconds = player.getCurrentTime();

  }




</script>
{% endblock %}
{% block footer %}
{{ super() }}
{% endblock %}

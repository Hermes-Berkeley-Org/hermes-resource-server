{% extends 'header.html' %}
{% block title %}Hermes | {{ cls_name }} - {{ name }}{% endblock %}
{% block head %}{{ super() }}{% endblock %}
{% block content %}

<div class="wrapper text-primary">
  <div class="row">
    <div class="col-md-7">
      <div id="ytplayer"></div>
      <div>
          <table id='transcript'>
            {% for transcript_element in transcript %}
              <tr>
                <td>{{transcript_element['begin']}}-{{transcript_element['end']}}</td>
                <td>{{transcript_element['text']}}</td>
              </tr>
            {% endfor %}
          </table>
      </div>
    </div>
    <div class="col-md-4">
      <div id="questions">
        <input id='question' placeholder='Enter your question here'></input>
        <input id='anonq'type="hidden" name="checkboxName" value="0"><input type="checkbox" onclick="this.previousSibling.value=1-this.previousSibling.value"> Anonymous?
        <button type=submit onclick="sendQuestion()">Submit Question</button>
      </div>
      <section id="questions_table">
        <!--<table id='questions_table'>-->
          {% for question in db['Questions'].find({'lecture_id': lecture}).sort([('seconds', 1)]) %}
            <!-- {{question['anon']}} -->

            {% if question['anon'] == "true" and role == consts.STUDENT %}
              <center><p class="question-tag"> Anonymous {{question['timestamp']}}</p></center>
            {% else %}
              <center><p class="question-tag">{{question['name']}} {{question['timestamp']}}</p></center>
            {% endif %}
            <div class="from-me">
              <p class="qa-entry">{{question['text']}}</p>
            </div>
            <button type="button" class="btn" data-toggle="collapse" data-target="#answers-{{question['_id']}}">Show responses / Submit Answer</button>
            <div class="clear"></div>
            <div id="answers-{{question['_id']}}" class="collapse">
                {% for answer in db['Answers'].find({'question_id': question['_id']}) %}
                    <div id="each-answer">
                    {% if answer['anon'] == "true" and role == consts.STUDENT %}
                        <p class="question-tag">Anonymous</p>
                        <div class="from-them">
                          <p class="qa-entry">Anonymous - {{answer['text']}}</p>
                    {% else %}
                        <p class="question-tag">{{answer['name']}}</p>
                        <div class="from-them">
                          <p class="qa-entry">{{answer['text']}}</p>
                    {% endif %}
                    </div>
                  </div>
                {% endfor %}
                    <input id="answer-{{question['_id']}}" placeholder='Enter your question here'></input>
                    <input id='anona' type="hidden" name="checkboxName" value="0"><input type="checkbox" onclick="this.previousSibling.value=1-this.previousSibling.value"> Anonymous?
                    <button type=submit onclick='sendAnswer("{{question['_id']}}")'>Submit Answer</button>
            </div>
            <div class="clear"></div>
          {% endfor %}
        <!--</table>-->
      </div>
    </div>
  </div>
</div>

<script>
  // Load the IFrame Player API code asynchronously.

  // https://www.youtube.com/watch?v=JPb1k6JdGvg
  var tag = document.createElement('script');
  tag.src = "https://www.youtube.com/player_api";
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  // Replace the 'ytplayer' element with an <iframe> and
  // YouTube player after the API code downloads.
  var player;
  function onYouTubePlayerAPIReady() {
    player = new YT.Player('ytplayer', {
      height: window.innerHeight / 2,
      width: window.innerWidth / 2,
      videoId: '{{ id }}',
      events: {
        'onStateChange': recordData
      }
    });
  }

  function recordData(event) {
      // Send info for student tracking purposes
  }

  function sendQuestion() {
      var seconds = player.getCurrentTime();
      var question = document.getElementById('question').value;
      var anonymous = document.getElementById('anonq').value;
      if(anonymous == "1"){
        anonymous = (true);
      }
      else{
        anonymous = (false);
      }
      var data = {
         seconds,
         text: question,
         name: "{{ user['name'] }}",
         ok_id: "{{ user['ok_id'] }}",
         lecture: "{{ lecture }}",
         cls: "{{ cls }}",
         anon: anonymous
      }

      console.log(`${JSON.stringify(data)}`)

      $.ajax({
        type: "POST",
        url: "{{ url_for('write_question') }}",
        data,
        success: function (data) {
          $('#questions_table').find("tr").remove();
          $('#questions_table').load(window.location.href + ' #questions_table');
        }
      });


  }

  function sendAnswer(questionId) {

      var answer = document.getElementById(`answer-${questionId}`).value;
      var anonymous = document.getElementById('anona').value;
      if(anonymous == "1"){
        anonymous = (true);
      }
      else{
        anonymous = (false);
      }
      var data = {
         question_id: questionId,
         text: answer,
         anon: anonymous
      };


      console.log(`${JSON.stringify(data)}`)

      $.ajax({
        type: "POST",
        url: "{{ url_for('write_answer') }}",
        data,
        success: function (data) {
          $(`#answers-${questionId}`).find("p").remove();
          $(`#answers-${questionId}`).load(window.location.href + ` #answers-${questionId}`);
        }
      });

  }



</script>
{% endblock %}
{% block footer %}
{{ super() }}
{% endblock %}

{% extends 'header.html' %}
{% block title %}Hermes | {{ cls_name }} - {{ name }}{% endblock %}
{% block head %}{{ super() }}{% endblock %}
{% block content %}

<div class="wrapper text-primary">
  <div class="row">
    <div class="col-md-7">
      <div id="ytplayer"></div>
      <div id="transcript">
            {% for (link, (start, end)) in preds %}
              <table class='transcript-box'>
              {% for i in range(start, end + 1) %}
                  <tr id="transcript-row-{{i}}" class="transcript-row">
                    <td>
                      <div class="dropdown" id="menu-{{i}}">
                      <span id="ts-{{2 * i}}"></span>
                        <a data-toggle="dropdown">
                          <span id="text-{{2 * i}}"></span>
                          <span id="text-{{2 * i + 1}}"></span>
                        </a>
                        <ul class="dropdown-menu">
                          {% if link %}
                          <li><a onclick="sendToURL('{{link}}')"> View section in textbook</a></li>
                          {% endif %}
                          <li><a onclick="fillQuestion({{i}})"> Ask a question</a></li>
                        </ul>
                      </div>
                    </td>
                  </tr>
              {% endfor %}
              </table>
            {% endfor %}
      </div>
    </div>
    <div class="col-md-4">
      <div id="questions">
        <!-- <form class="form-horizontal"> -->
          <div class="form-group">
            <input id='question' class="form-control" placeholder='Enter your question here'></input>
          </div>
          <div class="row">
            <div class="form-group col-md-6">
                <input id="anonq" type="checkbox">  Post anonymously</input>
            </div>
            <div class="form-group col-md-6">
              <button class="btn btn-primary submission" type=submit onclick="sendQuestion()">Submit Question</button>
            </div>
          </div>
        <!-- </form> -->
      </div>
      <section id="questions_table">
          {% for question_set, interval in partition(db['Questions'].find({'lecture_id': lecture}).sort([('seconds', 1), ('upvotes', 1)]), questions_interval, duration) %}
            {% if loop.index == 1 %}
                <a data-toggle="collapse" onclick="toggleResponses('partition-icon-{{loop.index}}')" data-target="#partition-{{loop.index}}"><span style="font-size: 18px" id="partition-icon-{{loop.index}}" class="fa fa-chevron-down qa-entry" aria-hidden="true"></span><strong>Top Questions</strong></a>
            {% else %}
                <a data-toggle="collapse" onclick="toggleResponses('partition-icon-{{loop.index}}')" data-target="#partition-{{loop.index}}"><span style="font-size: 18px" id="partition-icon-{{loop.index}}" class="fa fa-chevron-down qa-entry" aria-hidden="true"></span> {{interval[0]}} - {{interval[1]}}</a>
            {% endif %}

            <span style="display: block">
            <div id="partition-{{loop.index}}" class="collapse">


            {% for question in question_set %}

              <a id="show-answers-{{question['_id']}}" data-toggle="collapse" onclick="toggleResponses('toggle-icon-{{question['_id']}}')" data-target="#answers-{{question['_id']}}">
                <p><span class="fa fa-chevron-down qa-entry" id="toggle-icon-{{question['_id']}}" aria-hidden="true"></span></a>
                    <button class="btn btn-default btn-sm likes" id = "upvotes-{{question['_id']}}" type=submit onclick='upvoteQuestion("{{user['_id']}}", "{{question['_id']}}")'>
                      {% if user_id in question['upvotes'] %}
                      <i class="fa fa-thumbs-up" aria-hidden="true"></i> Like  {{ question['upvotes']|length }}
                      {% else %}
                      <i class="fa fa-thumbs-o-up" aria-hidden="true"></i> Like  {{ question['upvotes']|length }}
                      {% endif %}
                  </button>
                {% if question['anon'] == "true" and role == consts.STUDENT %}
                  <span class="question-tag-lg"> Anonymous {{question['timestamp']}}</span>
                {% else %}
                  <span class="question-tag-lg"> {{question['name']}} {{question['timestamp']}}</span>
                {% endif %}
                <span class="qa-entry-lg"> {{question['text']}}</span>
                {% if role == consts.INSTRUCTOR %}
                  <a onclick='deleteQuestion("{{question['_id']}}")'><span class="fa fa-close" style="color:red"></span></a>
                {% endif %}
                </p>
            <div id="answers-container-{{question['_id']}}">
            <!--<div class="clear"></div>-->
            <div id="answers-{{question['_id']}}" class="collapse">
                {% for answer in db['Answers'].find({'question_id': question['_id']}) %}
                    <div id="each-answer">
                      <p><span id="upvotes-{{answer['_id']}}" class="qa-entry">
                      <button class="btn btn-default btn-sm likes" type=submit onclick='upvoteAnswer("{{user['_id']}}", "{{answer['_id']}}")'>
                          {% if user_id in answer['upvotes'] %}
                          <i class="fa fa-thumbs-up" aria-hidden="true"></i> Like  {{ answer['upvotes']|length }}
                          {% else %}
                          <i class="fa fa-thumbs-o-up" aria-hidden="true"></i> Like  {{ answer['upvotes']|length }}
                          {% endif %}
                      </button>
                    </span>
                    {% if answer['anon'] == "true" and role == consts.STUDENT %}
                        <span class="question-tag"> Anonymous</span>
                        <!-- <div class="from-them"> -->
                          <span class="qa-entry"> {{answer['text']}}</span>
                        <!-- </div> -->
                    {% else %}
                        <span class="question-tag"> {{answer['name']}}</span>
                        <!-- <div class="from-them"> -->
                          <span class="qa-entry"> {{answer['text']}}</span>
                        <!-- </div> -->
                    {% endif %}
                    {% if role == consts.INSTRUCTOR %}
                      <a onclick='deleteAnswer("{{answer['_id']}}", "{{question['_id']}}")'><span class="fa fa-close" style="color:red"></span></a>
                    {% endif %}
                    </p>
                  </div>
                {% endfor %}
                  <!-- <form class="form-horizontal"> -->
                    <div class="form-group">
                    <input id="answer-{{question['_id']}}" class="form-control qa-entry" placeholder='Enter your answer here'></input>
                    </div>
                    <div class="row">
                      <div class="form-group col-md-6">
                        <input id='anona-{{question['_id']}}' type="checkbox"></input><span class="qa-entry">  Answer anonymously</span>
                      </div>
                      <div class="col-md-3"></div>
                      <div class="form-group col-md-3">
                      <button class="btn btn-primary btn-sm qa-entry submission" type="submit" onclick='sendAnswer("{{question['_id']}}")'>Submit Answer</button>
                    </div>
                  </div>
                  <!-- </form> -->
            </div>
            </div>
            <!-- <div class="clear"></div> -->

            {% endfor %}
          </div>
        </span>
          <!-- </td> -->
        <!-- </tr> -->

          {% endfor %}
        </section>
      <!-- </div> -->
        <!-- </table> -->
      </div>
    </div>
  </div>
</div>

<script>

  document.addEventListener('contextmenu', function(event) {
      var selObj = window.getSelection();
      var text = selObj.toString();
      if (text.length > 0) {
          event.preventDefault();
          var suggestionInput = document.createElement('input');
          suggestionInput.id = 'suggestion';
          suggestionInput.value = text;
          selObj.getRangeAt(0).surroundContents(suggestionInput);
          suggestionInput.innerHTML = '';
          $('#suggestion').keydown(function(event) {
              if (event.keyCode == 13) { // enter key
                  var parent = $(this).closest('span');
                  $(this).replaceWith($(this).val());
                  var text = parent.text();
                  var index = parent.attr('id').split('-').pop();

                  var data = {
                      text,
                      index,
                      lecture_id: '{{ lecture }}',
                      api_key: '{{ api_key }}'
                  }

                  $.ajax({
                    type: "POST",
                    url: "{{ url_for('edit_transcript') }}",
                    data
                  });

              }
          });
      }
  });

  var tag = document.createElement('script');
  tag.src = "https://www.youtube.com/player_api";
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  var player;
  function onYouTubePlayerAPIReady() {
    player = new YT.Player('ytplayer', {
      height: window.innerHeight / 2,
      width: window.innerWidth / 2,
      videoId: '{{ id }}',
      events: {
        'onStateChange': stateChange,
        'onReady': onPlayerReady
      }
    });

  }

  function onPlayerReady() {
      toggleTopQuestions();

      var convertToSeconds = function(timestamp) {
          var data = timestamp.split(':');
          var hours = data[0];
          var minutes = data[1];
          var seconds = data[2];
          return (parseInt(hours) * 360 + parseInt(minutes) * 60 + parseFloat(seconds))
      };

      var convertToSecondsTiny = function(timestamp) {
          var data = timestamp.split(':');
          var minutes = data[0];
          var seconds = data[1];
          return (parseInt(minutes) * 60 + parseFloat(seconds))
      };

      var cleanTimestamp = function(timestamp) {
          var data = timestamp.split(':');
          var hours = data[0];
          var minutes = data[1];
          var seconds = data[2];
          var output = "";
          if (parseInt(hours) > 0) {
              output += hours.toString() + ":";
          }
          output += minutes.toString() + ':';
          var roundedSeconds = Math.round(parseFloat(seconds));
          if (roundedSeconds < 10) {
              output += "0";
          }
          output += roundedSeconds.toString();
          return output;
      }

      var timestamps = [];
      {% for transcript_element in transcript %}
      timestamps.push(convertToSeconds("{{transcript_element['begin']}}"));
      {% endfor %}

      setInterval(function() {
          var currentTime = player.getCurrentTime();
          var state = player.getPlayerState();
          // alert(currentTime);
          {% for transcript_element in transcript %}
          if (currentTime >= timestamps[{{loop.index - 1}}]) {
              if ($("#text-{{loop.index - 1}}").contents().length == 0) {
                  var p1 = document.getElementById("ts-{{loop.index - 1}}");
                  if (p1) {
                      p1.innerHTML = cleanTimestamp("{{transcript_element['begin']}}")
                  }
                  var p2 = document.getElementById("text-{{loop.index - 1}}");
                  p2.innerHTML = "{{transcript_element['text']}}";
                  document.getElementById("menu-{{loop.index // 2}}").style.visibility = "visible";
              }
          }
          {% endfor %}

          {% for begin, end in partition_titles %}
          if (currentTime >= convertToSecondsTiny("{{begin}}") && currentTime < convertToSecondsTiny("{{end}}")) {
            if (state == 1) { // video is playing
              var collapseButton = $("a:contains('{{begin}} - {{end}}')");
              var div = $(collapseButton.attr('data-target'));
              if (div && div.attr('class') && div.attr('class').split(' ').indexOf('show') == -1) {
                console.log(collapseButton.children()[0].id);
                toggleResponses(collapseButton.children()[0].id);
                div.collapse('show');
              }
            }
          }
          {% endfor %}
      }, {{questions_interval}} * 250);

  }

  function stateChange() {
      // recordData maybe
  }

  function toggleTopQuestions() {
      toggleResponses('partition-icon-1');
      $('#partition-1').collapse("show");
  }

  function toggleResponses(buttonId) {
    elem = document.getElementById(buttonId);
    if (elem) {
      if (elem.classList.contains('fa-chevron-down')) {
        elem.classList.remove('fa-chevron-down');
        elem.classList.add('fa-chevron-up');
      } else {
        elem.classList.remove('fa-chevron-up');
        elem.classList.add('fa-chevron-down');
      }
    }
  }

  function sendQuestion() {
      var seconds = player.getCurrentTime();
      var question = document.getElementById('question').value;
      if (question.length > 0) {
        var anonymous = $('#anonq').is(":checked");
        var data = {
           seconds,
           text: question,
           name: "{{ user['name'] }}",
           ok_id: "{{ user['ok_id'] }}",
           lecture: "{{ lecture }}",
           cls: "{{ cls }}",
           anon: anonymous,
           api_key: "{{ api_key }}"
        }

        console.log(`${JSON.stringify(data)}`)

        $.ajax({
          type: "POST",
          url: "{{ url_for('write_question') }}",
          data,
          success: function (data) {
            $('#questions_table').load(window.location.href + ' #questions_table', function () {
                toggleTopQuestions()
            });

          }
        });
      }
    }

  function deleteQuestion(question) {
    var data = {
      question_id: question,
      api_key: "{{ api_key }}"
    }

    $.ajax({
      type: "POST",
      url: "{{ url_for('delete_question') }}",
      data: data,
      success: function (data) {
        $('#questions_table').load(window.location.href + ' #questions_table', function () {
            toggleTopQuestions()
        });
      }
    })
  }

  function deleteAnswer(answer, question) {
    var data = {
      answer_id: answer,
      api_key: "{{ api_key }}"
    };

    question_id = question;
    console.log(question);

    $.ajax({
      type: "POST",
      url: "{{ url_for('delete_answer') }}",
      data,
      success: function (data) {
        $(`#answers-container-${question}`).load(window.location.href + ` #answers-container-${question}`, function () {
            $(`#show-answers-${question}`).trigger("click", function () {
                toggleTopQuestions()
            });
        });
      }
    })
  }

  function upvoteAnswer(user, answer){
    var currentcount = document.getElementById(`upvotes-${answer}`).value;
    var data ={
      user_id:user,
      answer_id:answer,
      api_key: "{{ api_key }}"
    };
    console.log(`${JSON.stringify(data)}`)
    $.ajax({
      type: "POST",
      url: "{{ url_for('upvote_answer') }}",
      data,
      success: function (data) {

        $(`#upvotes-${answer}`).load(window.location.href + ` #upvotes-${answer}`, function () {
            toggleTopQuestions()
        });
      }
    });
  }

  function upvoteQuestion(user, question){
    var data ={
      user_id:user,
      question_id:question,
      api_key: "{{ api_key }}"
    };
    console.log(`${JSON.stringify(data)}`)
    $.ajax({
      type: "POST",
      url: "{{ url_for('upvote_question') }}",
      data,
      success: function (data) {
        $(`#upvotes-${question}`).load(window.location.href + ` #upvotes-${question}`, function () {
            toggleTopQuestions()
        });
      }
    });
  }
  function sendAnswer(questionId) {

      var answer = document.getElementById(`answer-${questionId}`).value;
      var anonymous = $(`#anona-${questionId}`).is(":checked");;

      if (answer.length > 0) {
          if(anonymous == "1"){
            anonymous = (true);
          }
          else{
            anonymous = (false);
          }
          var data = {
             question_id: questionId,
             text: answer,
             anon: anonymous,
             api_key: "{{ api_key }}"
          };


          console.log(`${JSON.stringify(data)}`)

          $.ajax({
            type: "POST",
            url: "{{ url_for('write_answer') }}",
            data,
            success: function (data) {
              $(`#answers-container-${questionId}`).load(window.location.href + ` #answers-container-${questionId}`, function () {
                  $(`#show-answers-${questionId}`).trigger("click", function () {
                      toggleTopQuestions()
                  });
              });


            }
          });
      }
  }

  function sendToURL(url) {
      window.open(
        url,
        '_blank'
      );
  }

  function fillQuestion(rowIndex) {
      document.getElementById('question').value = document.getElementById(`transcript-row-${rowIndex}`).textContent.replace(/\s+/g, ' ');
  }



</script>
{% endblock %}
{% block footer %}
{{ super() }}
{% endblock %}

{% extends 'header.html' %}
{% block title %}Hermes | {{ cls_name }} - {{ name }}{% endblock %}
{% block head %}{{ super() }}{% endblock %}
{% block content %}

<div class="wrapper text-primary">
  <div class="row">
    <div class="col-md-7">
      <div id="ytplayer"></div>
      <div>
          <table id='transcript'>
            {% for transcript_element in transcript %}
              <tr>
                <td>{{transcript_element['begin']}}-{{transcript_element['end']}}</td>
                <td>{{transcript_element['text']}}</td>
              </tr>
            {% endfor %}
          </table>
      </div>
    </div>
    <div class="col-md-4">
      <div id="questions">
        <!-- <form class="form-horizontal"> -->
          <div class="form-group">
            <input id='question' class="form-control" placeholder='Enter your question here'></input>
          </div>
          <div class="row">
            <div class="form-group col-md-6">
                <input id="anonq" type="checkbox">  Post anonymously</input>
            </div>
            <div class="form-group col-md-6">
              <button class="btn btn-primary submission" type=submit onclick="sendQuestion()">Submit Question</button>
            </div>
          </div>
        <!-- </form> -->
      </div>
      <section id="questions_table">
        <!--<table id='questions_table'>-->
          {% for question in db['Questions'].find({'lecture_id': lecture}).sort([('seconds', 1)]) %}
            <!-- {{question['anon']}} -->

            <!-- <div class="from-me"> -->
              <a id="show-answers-{{question['_id']}}" data-toggle="collapse" onclick="toggleResponses('toggle-icon-{{question['_id']}}')" data-target="#answers-{{question['_id']}}">
                <p><span class="fa fa-chevron-down qa-entry" id="toggle-icon-{{question['_id']}}" aria-hidden="true"></span>
                {% if question['anon'] == "true" and role == consts.STUDENT %}
                  <span class="question-tag-lg"> Anonymous {{question['timestamp']}}</span>
                {% else %}
                  <span class="question-tag-lg"> {{question['name']}} {{question['timestamp']}}</span>
                {% endif %}
                <span class="qa-entry-lg"> {{question['text']}}</span></p>
              </a>
            <!-- </div> -->
            <div id="answers-container-{{question['_id']}}">
            <!--<div class="clear"></div>-->
            <div id="answers-{{question['_id']}}" class="collapse">
                {% for answer in db['Answers'].find({'question_id': question['_id']}) %}
                    <div id="each-answer">
                      <p><span id="upvotes-{{answer['_id']}}" class="qa-entry">
                      <button class="btn btn-default btn-sm likes" type=submit onclick='upvoteAnswer("{{user['_id']}}", "{{answer['_id']}}")'>
                          {% if user_id in answer['upvotes'] %}
                          <i class="fa fa-thumbs-up" aria-hidden="true"></i> Like  {{ answer['upvotes']|length }}
                          {% else %}
                          <i class="fa fa-thumbs-o-up" aria-hidden="true"></i> Like  {{ answer['upvotes']|length }}
                          {% endif %}
                      </button>
                    </span>
                    {% if answer['anon'] == "true" and role == consts.STUDENT %}
                        <span class="question-tag"> Anonymous</span>
                        <!-- <div class="from-them"> -->
                          <span class="qa-entry"> {{answer['text']}}</span>
                        <!-- </div> -->
                    {% else %}
                        <span class="question-tag"> {{answer['name']}}</span>
                        <!-- <div class="from-them"> -->
                          <span class="qa-entry"> {{answer['text']}}</span>
                        <!-- </div> -->
                    {% endif %}
                    </p>
                  </div>
                {% endfor %}
                  <!-- <form class="form-horizontal"> -->
                    <div class="form-group">
                    <input id="answer-{{question['_id']}}" class="form-control qa-entry" placeholder='Enter your answer here'></input>
                    </div>
                    <div class="row">
                      <div class="form-group col-md-6">
                        <input id='anona-{{question['_id']}}' type="checkbox"></input><span class="qa-entry">  Answer anonymously</span>
                      </div>
                      <div class="col-md-3"></div>
                      <div class="form-group col-md-3">
                      <button class="btn btn-primary btn-sm qa-entry submission" type="submit" onclick='sendAnswer("{{question['_id']}}")'>Submit Answer</button>
                    </div>
                  </div>
                  <!-- </form> -->
            </div>
          </div>
            <div class="clear"></div>
          {% endfor %}
        <!-- </section>
      </div> -->
        <!--</table>-->
      </div>
    </div>
  </div>
</div>

<script>
  // Load the IFrame Player API code asynchronously.

  // https://www.youtube.com/watch?v=JPb1k6JdGvg
  var tag = document.createElement('script');
  tag.src = "https://www.youtube.com/player_api";
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  // Replace the 'ytplayer' element with an <iframe> and
  // YouTube player after the API code downloads.
  var player;
  function onYouTubePlayerAPIReady() {
    player = new YT.Player('ytplayer', {
      height: window.innerHeight / 2,
      width: window.innerWidth / 2,
      videoId: '{{ id }}',
      events: {
        'onStateChange': recordData
      }
    });

    // player.at('')

  }

  function recordData(event) {
      // Send info for student tracking purposes
  }

  function toggleResponses(buttonId) {
    elem = document.getElementById(buttonId);
    if (elem.classList.contains('fa-chevron-down')) {
      elem.classList.remove('fa-chevron-down');
      elem.classList.add('fa-chevron-up');
    } else {
      elem.classList.remove('fa-chevron-up');
      elem.classList.add('fa-chevron-down');
    }
  }

  function sendQuestion() {
      var seconds = player.getCurrentTime();
      var question = document.getElementById('question').value;
      if (question.length > 0) {
        var anonymous = $('#anonq').is(":checked");
        var data = {
           seconds,
           text: question,
           name: "{{ user['name'] }}",
           ok_id: "{{ user['ok_id'] }}",
           lecture: "{{ lecture }}",
           cls: "{{ cls }}",
           anon: anonymous
        }

        console.log(`${JSON.stringify(data)}`)

        $.ajax({
          type: "POST",
          url: "{{ url_for('write_question') }}",
          data,
          success: function (data) {
            $('#questions_table').load(window.location.href + ' #questions_table');
          }
        });
      }
    }

  function upvoteAnswer(user, answer){
    var currentcount = document.getElementById(`upvotes-${answer}`).value;
    var data ={
      user_id:user,
      answer_id:answer
    };
    console.log(`${JSON.stringify(data)}`)
    $.ajax({
      type: "POST",
      url: "{{ url_for('upvote_answer') }}",
      data,
      success: function (data) {

        $(`#upvotes-${answer}`).load(window.location.href + ` #upvotes-${answer}`);
      }
    });
  }
  function sendAnswer(questionId) {

      var answer = document.getElementById(`answer-${questionId}`).value;
      var anonymous = $(`#anona-${questionId}`).is(":checked");;

      if (answer.length > 0) {
          if(anonymous == "1"){
            anonymous = (true);
          }
          else{
            anonymous = (false);
          }
          var data = {
             question_id: questionId,
             text: answer,
             anon: anonymous
          };


          console.log(`${JSON.stringify(data)}`)

          $.ajax({
            type: "POST",
            url: "{{ url_for('write_answer') }}",
            data,
            success: function (data) {
              // $(`#answers-${questionId}`).find("p").remove()
              $(`#answers-container-${questionId}`).load(window.location.href + ` #answers-container-${questionId}`, function () {
                  $(`#show-answers-${questionId}`).trigger("click");
              });


            }
          });
      }
  }





</script>
{% endblock %}
{% block footer %}
{{ super() }}
{% endblock %}

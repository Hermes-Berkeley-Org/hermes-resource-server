{% extends 'header.html' %}
{% block title %}Hermes | {{ cls_name }} - {{ name }}{% endblock %}
{% block head %}{{ super() }}{% endblock %}
{% block content %}

<div class="wrapper text-primary">
  <div class="row">
    <div class="col-md-7">
      <div id="ytplayer"></div>
      <div>
          <table id='transcript'></table>
      </div>
    </div>
    <div class="col-md-4">
      <div id="questions">
        <!-- <form class="form-horizontal"> -->
          <div class="form-group">
            <input id='question' class="form-control" placeholder='Enter your question here'></input>
          </div>
          <div class="form-group">
              <input id="anonq" type="checkbox">Post anonymously</input>
          </div>
          <div class="form-group">
            <button class="btn btn-primary" type=submit onclick="sendQuestion()">Submit Question</button>
          </div>
        <!-- </form> -->
      </div>
      <section id="questions_table">
        <!--<table id='questions_table'>-->
          {% for question in db['Questions'].find({'lecture_id': lecture}).sort([('seconds', 1)]) %}
            <!-- {{question['anon']}} -->

            {% if question['anon'] == "true" and role == consts.STUDENT %}
              <center><p class="question-tag"> Anonymous {{question['timestamp']}}</p></center>
            {% else %}
              <center><p class="question-tag">{{question['name']}} {{question['timestamp']}}</p></center>
            {% endif %}
            <!-- <div class="from-me"> -->
              <p class="qa-entry">{{question['text']}}</p>
            <!-- </div> -->
            <div id="answers-container-{{question['_id']}}">
            <a id="show-answers-{{question['_id']}}" data-toggle="collapse" onclick="toggleResponses('show-answers-{{question['_id']}}')" data-target="#answers-{{question['_id']}}">></a>
            <div class="clear"></div>
            <div id="answers-{{question['_id']}}" class="collapse">
                {% for answer in db['Answers'].find({'question_id': question['_id']}) %}
                    <div id="each-answer">
                    {% if answer['anon'] == "true" and role == consts.STUDENT %}
                        <p class="question-tag">Anonymous</p>
                        <!-- <div class="from-them"> -->
                          <p class="qa-entry">{{answer['text']}}</p>
                        <!-- </div> -->
                    {% else %}
                        <p class="question-tag">{{answer['name']}}</p>
                        <!-- <div class="from-them"> -->
                          <p class="qa-entry">{{answer['text']}}</p>
                        <!-- </div> -->
                    {% endif %}
                    <div id="upvotes-{{answer['_id']}}">
                      <button class="btn btn-default btn-sm" type=submit onclick='upvoteAnswer("{{user['_id']}}", "{{answer['_id']}}")'>
                          {% if user_id in answer['upvotes'] %}
                          <i class="fa fa-thumbs-up" aria-hidden="true"></i> Like  {{ answer['upvotes']|length }}
                          {% else %}
                          <i class="fa fa-thumbs-o-up" aria-hidden="true"></i> Like  {{ answer['upvotes']|length }}
                          {% endif %}
                      </button>
                    </div>
                  </div>
                {% endfor %}
                  <!-- <form class="form-horizontal"> -->
                    <div class="form-group">
                    <input id="answer-{{question['_id']}}" class="form-control input-sm" placeholder='Enter your answer here'></input>
                    </div>
                    <div class="form-group">
                      <input id='anona-{{question['_id']}}' type="checkbox">Answer anonymously</input>
                    </div>
                    <div class="form-group">
                    <button class="btn btn-primary btn-sm" type=submit onclick='sendAnswer("{{question['_id']}}")'>Submit Answer</button>
                  </div>
                  <!-- </form> -->
            </div>
          </div>
            <div class="clear"></div>
          {% endfor %}
        <!-- </section>
      </div> -->
        <!--</table>-->
      </div>
    </div>
  </div>
</div>

<script>
  // Load the IFrame Player API code asynchronously.

  // https://www.youtube.com/watch?v=JPb1k6JdGvg
  var tag = document.createElement('script');
  tag.src = "https://www.youtube.com/player_api";
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  // Replace the 'ytplayer' element with an <iframe> and
  // YouTube player after the API code downloads.
  var player;
  function onYouTubePlayerAPIReady() {
    player = new YT.Player('ytplayer', {
      height: window.innerHeight / 2,
      width: window.innerWidth / 2,
      videoId: '{{ id }}',
      events: {
        'onStateChange': recordData,
        'onReady': onPlayerReady
      }
    });

  }

  function onPlayerReady() {
      var convertToSeconds = function(timestamp) {
          var data = timestamp.split(':');
          var hours = data[0];
          var minutes = data[1];
          var seconds = data[2];
          return (parseInt(hours) * 360 + parseInt(minutes) * 60 + parseFloat(seconds))
      };

      var cleanTimestamp = function(timestamp) {
          var data = timestamp.split(':');
          var hours = data[0];
          var minutes = data[1];
          var seconds = data[2];
          var output = "";
          if (parseInt(hours) > 0) {
              output += hours.toString() + ":";
          }
          output += minutes.toString() + ':';
          var roundedSeconds = Math.round(parseFloat(seconds));
          if (roundedSeconds < 10) {
              output += "0";
          }
          output += roundedSeconds.toString();
          return output;
      }

      var timestamps = [];
      {% for transcript_element in transcript %}
      timestamps.push(convertToSeconds("{{transcript_element['begin']}}"));
      {% endfor %}

      setInterval(function() {
          var currentTime = player.getCurrentTime();
          // alert(currentTime);
          {% for transcript_element in transcript %}
          if (currentTime >= timestamps[{{loop.index - 1}}]) {
              var tr = document.createElement("tr");
              var td1 = document.createElement("td");
              td1.innerHTML = cleanTimestamp("{{transcript_element['begin']}}")
              var td2 = document.createElement("td");
              td2.innerHTML = "{{transcript_element['text']}}";
              td2.id = 'transcript-elem-' + '{{loop.index - 1}}';
              tr.appendChild(td1)
              tr.appendChild(td2);
              if ($(`#${td2.id}`).length == 0) {
                  $('#transcript').append(tr);
              }
          }
          {% endfor %}
      }, 3000);


  }

  function recordData(event) {
      // Send info for student tracking purposes
  }

  function toggleResponses(buttonId) {
      var possibleTexts = [">", "<"];
      document.getElementById(buttonId).innerHTML = possibleTexts[1 - possibleTexts.indexOf(document.getElementById(buttonId).innerHTML)];
  }

  function sendQuestion() {
      var seconds = player.getCurrentTime();
      var question = document.getElementById('question').value;
      if (question.length > 0) {
        var anonymous = $('#anonq').is(":checked");
        var data = {
           seconds,
           text: question,
           name: "{{ user['name'] }}",
           ok_id: "{{ user['ok_id'] }}",
           lecture: "{{ lecture }}",
           cls: "{{ cls }}",
           anon: anonymous
        }

        console.log(`${JSON.stringify(data)}`)

        $.ajax({
          type: "POST",
          url: "{{ url_for('write_question') }}",
          data,
          success: function (data) {
            $('#questions_table').load(window.location.href + ' #questions_table');
          }
        });
      }
    }

  function upvoteAnswer(user, answer){
    var currentcount = document.getElementById(`upvotes-${answer}`).value;
    var data ={
      user_id:user,
      answer_id:answer
    };
    console.log(`${JSON.stringify(data)}`)
    $.ajax({
      type: "POST",
      url: "{{ url_for('upvote_answer') }}",
      data,
      success: function (data) {

        $(`#upvotes-${answer}`).load(window.location.href + ` #upvotes-${answer}`);
      }
    });
  }
  function sendAnswer(questionId) {

      var answer = document.getElementById(`answer-${questionId}`).value;
      var anonymous = $(`#anona-${questionId}`).is(":checked");;

      if (answer.length > 0) {
          if(anonymous == "1"){
            anonymous = (true);
          }
          else{
            anonymous = (false);
          }
          var data = {
             question_id: questionId,
             text: answer,
             anon: anonymous
          };


          console.log(`${JSON.stringify(data)}`)

          $.ajax({
            type: "POST",
            url: "{{ url_for('write_answer') }}",
            data,
            success: function (data) {
              // $(`#answers-${questionId}`).find("p").remove()
              $(`#answers-container-${questionId}`).load(window.location.href + ` #answers-container-${questionId}`, function () {
                  $(`#show-answers-${questionId}`).trigger("click");
              });


            }
          });
      }
  }





</script>
{% endblock %}
{% block footer %}
{{ super() }}
{% endblock %}

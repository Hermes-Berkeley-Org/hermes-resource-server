{% extends 'header.html' %}
{% block title %}Hermes | Edit {{ cls_name }} - {{ name }}{% endblock %}
{% block head %}{{ super() }}{% endblock %}
{% block content %}
<div class="wrapper text-primary">
    <!-- The screen and forms below are invisible / out of the screen until user triggers them -->
    <div id="black-transparent-screen">
    </div>
    <div id="vitamin-form">
      <h4>Add Vitamin at <span id="timestamp"></span></h4>
        <div class="form-group">
            <input id='vitamin-question' class="form-control popup-input" placeholder='Enter your vitamin question here'></input>
        </div>

          <div class="form-group">
          <!-- <input id='vitamin-answer' class="form-control popup-input" placeholder='Enter your vitamin answer here'></input> -->
            <div class="vitamin-answer">
              <p id="instructions">Please enter 2-4 choices, then use the buttons to choose the correct answer.</p>
              <p class="incorrect" id="incorrect-input"></p>
              <div class="row">
                <div class="col-md-6" style="display: inline;">
                  <input id="button1" name="choices" type="radio" required>   <input id="choice1" class="form-control mcq-choices" placeholder="Choice A" />
                </div>
                <div class="col-md-6" style="display: inline;">
                  <input id="button2" name="choices" type="radio" required>   <input id="choice2" class="form-control mcq-choices" placeholder="Choice B" />
                </div>
              </div>
              <div class="row">
                <div class="col-md-6" style="display: inline;">
                  <input id="button3" name="choices" type="radio" required>   <input id="choice3" class="form-control mcq-choices" placeholder="Choice C" />
                </div>
                <div class="col-md-6" style="display: inline;">
                  <input id="button4" name="choices" type="radio" required>   <input id="choice4" class="form-control mcq-choices" placeholder="Choice D" />
                </div>
              </div>
            </div>
          </div>
          <div class="row">
              <div class="col-md-6">
                  <center><button class="btn btn-danger" type=submit onclick="removeForm()"><i class="fa fa-ban"></i>  Cancel</button></center>
              </div>
              <div class="col-md-6">
                  <center><button class="btn btn-primary" type=submit onclick="addVitamin()"><i class="fa fa-plus"></i>  Add Vitamin</button></center>
              </div>
          </div>


    </div>
    <div class="row">
        <div class="col-md-7">
          <div id="ytplayer"></div>
          {% if playlist_number %}
          <div class="navbar">
          {% if playlist_number|int != 0|int %}
          <a href={{ url_for('edit_lecture', cls= cls_num, lecture_number= lecture_num, playlist_number= ((playlist_number|int - 1|int)|string)) }}>
            <button class="btn btn-primary submission" >Previous Video</button>
          </a>
          {% endif %}
          {% for lec in range(num_videos) %}
          {% if playlist_number|int == lec|int %}
            <b><u><font size ="2" color="black"> {{lec}}. {{vid_titles[lec]}}</font></u></b>
          {% else %}
            <font size ="2"><a href={{ url_for('edit_lecture', cls= cls_num, lecture_number= lecture_num, playlist_number= lec) }}>{{lec}}.{{vid_titles[lec]}}</a></font>
          {% endif %}
          {% endfor %}
          {% if playlist_number|int < (num_videos-1)|int %}
            <a href={{ url_for('edit_lecture', cls= cls_num, lecture_number= lecture_num, playlist_number= ((playlist_number|int + 1|int)|string)) }}>
              <button class="btn btn-primary submission" >Next Video</button>
            </a>
          {% endif %}
          </div>
          {% endif %}
        </div>
        <div class="col-md-4">
            <div class="row">
                <div class="col-md-6"></div>
                <div class="col-md-6">
                    <button class="btn btn-primary submission" type=submit onclick="addVitaminForm()"><i class="fa fa-question"></i>  Add Vitamin</button>
                </div>
                <!--
                <div class="col-md-6">
                    <button class="btn btn-primary submission" type=submit onclick="addResourceForm()"><i class="fa fa-sticky-note"></i>  Add Resource</button>
                </div>
                -->
            </div>
            <section id="vitamin-container">
                <a data-toggle="collapse" onclick="toggleResponses('vitamin-icon')" data-target="#vitamins"><span style="font-size: 18px" id="vitamin-icon" class="fa fa-chevron-down qa-entry" aria-hidden="true"></span><strong>Vitamins</strong></a>
                <div id="vitamins" class="collapse">
                    {% for vitamin in db['Vitamins'].find({'$and':[{'lecture_id': lecture}, {'playlist_number': playlist_number|string }]}) %}
                        <a id="show-vitamin-{{vitamin['_id']}}" data-toggle="collapse" onclick="toggleResponses('toggle-icon-{{vitamin['_id']}}')" data-target="#vitamin-content-{{vitamin['_id']}}">
                            <p><span class="fa fa-chevron-down qa-entry" id="toggle-icon-{{vitamin['_id']}}" aria-hidden="true"></span>
                        </a>
                        <span class="qa-entry-lg">{{ vitamin['timestamp'] }} <i class="fa fa-close" style="color:red" onclick='deleteVitamin("{{vitamin['_id']}}")'></i></span>
                            <div id="vitamin-content-{{ vitamin['_id'] }}" class="collapse qa-entry-lg">
                                <span class="qa-entry">Question: {{ vitamin['question'] }}</span><br>
                                <span class="qa-entry">Answer: {{ vitamin['answer'] }}</span><br>
                                <span class="qa-entry">Choices:
                                  {% for choice in vitamin['choices'] %}
                                    {% if loop.index == 1 %}
                                      {{ choice }}
                                    {% else %}
                                      , {{ choice }}
                                    {% endif %}
                                  {% endfor %}
                                </span>
                            </div>
                        </p>
                    {% endfor %}
                </div>
            </section>
            <section id="resource-container" class="collapse">
            </section>
        </div>
    </div>
</div>

<script>
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/player_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    var player;
    function onYouTubePlayerAPIReady() {
        player = new YT.Player('ytplayer', {
            height: window.innerHeight / 2,
            width: window.innerWidth / 2,
            videoId: '{{ id }}'
        });
    }

    function convertToTimestamp(seconds) {
      var remainder = (seconds % 60) | 0;
      if (seconds < 3600) {
        var minutes = (seconds / 60) | 0;
        if (remainder >= 10) {
          return minutes + ":" + remainder;
        } else {
          return minutes + ":0" + remainder;
        }
      } else {
        var hours = (seconds / 3600) | 0;
        var minutes = ((seconds - hours * 3600) / 60) | 0;
        if (minutes >= 10) {
          if (remainder >= 10) {
            return hours + ":" + minutes + ":" + remainder;
          } else {
            return hours + ":" + minutes + ":0" + remainder;
          }
        } else {
          if (remainder >= 10) {
            return hours + ":0" + minutes + ":" + remainder;
          } else {
            return hours + ":0" + minutes + ":0" + remainder;
          }
        }
      }
    }

    function addVitaminForm() {
        player.pauseVideo();
        var seconds = player.getCurrentTime();
        if (seconds < 1) {
          alert('Please do not add a vitamin within the first second.');
        } else {
          document.getElementById('timestamp').innerHTML = convertToTimestamp(seconds);
          document.getElementById('black-transparent-screen').classList.add('show');
          document.getElementById('vitamin-form').classList.add('show');
        }
    }

    function addResourceForm() {
        player.pauseVideo();
    }

    function removeForm() {
        document.getElementById('black-transparent-screen').classList.remove('show');

        var vitamin_form = document.getElementById('vitamin-form');
        var resource_form = document.getElementById('resource-form');
        if (vitamin_form.classList.contains('show')) {
            vitamin_form.classList.remove('show');
        } else {
            resource_form.classList.remove('show');
        }
    }

    function addVitamin() {
        var seconds = player.getCurrentTime();
        var question = document.getElementById('vitamin-question').value;
        var answer = "";
        var choices = [];
        var options = 0;
        for (var i = 1; i <= 4; i++) {
          var selected = 'button' + i;
          var choice = document.getElementById('choice' + i).value;
          if (document.getElementById(selected).checked && choice != "") {
            answer = choice;
          }
          choices.push(choice);
          if (choice.length > 0) {
            options++;
          }
        }
        if (question.length > 0 && answer.length > 0 && options >= 2) {
            document.getElementById('incorrect-input').innerHTML = "";
            var data = {
               seconds: seconds,
               question: question,
               answer: answer,
               choice1: choices[0],
               choice2: choices[1],
               choice3: choices[2],
               choice4: choices[3],
               lecture_id: "{{ lecture }}",
               playlist_number: "{{ playlist_number }}",
               user_id: '{{ user["_id"] }}',
               class_ok_id: '{{ cls }}'
            }

            console.log(`${JSON.stringify(data)}`);

            $.ajax({
              type: "POST",
              url: "{{ url_for('add_vitamin') }}",
              data,
              success: function (data) {
                $('#vitamin-container').load(window.location.href + ' #vitamin-container', function () {
                    removeForm();
                    toggleResponses('vitamin-icon');
                    $('#vitamins').collapse("show");
                });

              }
            });
        } else {
          document.getElementById('incorrect-input').innerHTML = "There was an error with your input. Please double check them.";
        }
    }

    function deleteVitamin(vitamin) {
        var data = {
          vitamin_id: vitamin,
          user_id: '{{ user["_id"] }}',
          class_ok_id: '{{ cls }}'
        }

        $.ajax({
          type: "POST",
          url: "{{ url_for('delete_vitamin') }}",
          data: data,
          success: function (data) {
            $('#vitamin-container').load(window.location.href + ' #vitamin-container', function () {
                toggleResponses('vitamin-icon');
                $('#vitamins').collapse("show");
            });
          }
        })
    }

    function toggleResponses(buttonId) {
        elem = document.getElementById(buttonId);
        if (elem) {
          if (elem.classList.contains('fa-chevron-down')) {
            elem.classList.remove('fa-chevron-down');
            elem.classList.add('fa-chevron-up');
          } else {
            elem.classList.remove('fa-chevron-up');
            elem.classList.add('fa-chevron-down');
          }
        }
    }


</script>
{% endblock %}
{% block footer %}
{{ super() }}
{% endblock %}
